_format_version: "3.0"
_transform: true

vaults:
  - name: env
    prefix: my-env-vault
    config:
      prefix: "SECURE_"

services:
  - name: user-serv
    url: http://user-serv.zeabur.internal:8080
    routes:
      # âœ… ç™»å…¥ï¼šä¸éœ€è¦ JWT
      - name: auth-google
        paths:
          - /v1/auth/google
        strip_path: false
        protocols: [http, https]

      # âœ… é€™å…©æ¢å…¬é–‹ï¼šä¸éœ€è¦ JWT
      - name: v1-public-user-driver
        paths:
          # /v1/users/<id>
          - ~/v1/users/[^/]+$
          # /v1/drivers/user/<user_id>
          - ~/v1/drivers/user/[^/]+$
        strip_path: false
        protocols: [http, https]

      # âœ… å…¶é¤˜ /v1ï¼šéœ€è¦ JWTï¼ˆæ’é™¤ä¸Šé¢å…©æ¢ï¼‰
      - name: v1-protected
        paths:
          # ä»»ä½• /v1 é–‹é ­ï¼Œä½†ä¸è¦åŒ¹é… /v1/users/<id> èˆ‡ /v1/drivers/user/<user_id>
          - ~/v1(?!/users/[^/]+$)(?!/drivers/user/[^/]+$).*
        strip_path: false
        protocols: [http, https]


  - name: post-serv
    url: http://post-serv.zeabur.internal:8080
    routes:
      # âœ… å…¬é–‹è²¼æ–‡åˆ—è¡¨ï¼ˆä¸éœ€è¦ JWTï¼‰
      - name: api-posts-public
        paths:
          - /api/posts/all
        strip_path: false
        protocols: [http, https]

      # ğŸ”’ å…¶é¤˜ /api æ‰éœ€è¦ JWT
      - name: api-protected
        paths:
          - ~/api(?!/posts/all$).*
        strip_path: false
        protocols: [http, https]


  - name: admin-serv
    url: http://admin-serv.zeabur.internal:8080
    routes:
      - name: admin-protected
        paths: [/admin]
        strip_path: false
        protocols: [http, https]

consumers:
  - username: user-serv

jwt_secrets:
  - consumer: user-serv
    key: ntouber-user-serv
    secret: "f96dc63c15c49f1a181ba0d0df75d215381f0c5b12d27487402d66153405da33215da02619237d78f38f9e8bf863a98e"   # è®€ env: SECURE_JWT_SECRET
    algorithm: HS256

plugins:
  - name: jwt
    route: v1-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  - name: jwt
    route: api-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  - name: jwt
    route: admin-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  - name: cors
    config:
      origins:
        - https://ntouber.zeabur.app
        - http://localhost:8080
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - Authorization
      credentials: false
      max_age: 3600
