plugins:
  # ======================
  # JWT（原本設定，未修改）
  # ======================
  - name: jwt
    route: v1-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  - name: jwt
    route: api-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  - name: jwt
    route: admin-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  # ======================
  # Rate Limiting（新增）
  # ======================

  # 1️⃣ 登入 API（防止暴力登入）
  - name: rate-limiting
    route: auth-google
    config:
      minute: 20
      limit_by: ip
      policy: local
      fault_tolerant: true

  # 2️⃣ 使用者 API（依 JWT 使用者限流）
  - name: rate-limiting
    route: v1-protected
    config:
      minute: 300
      limit_by: consumer
      policy: local
      fault_tolerant: true

  # 3️⃣ Post 搜尋 API（高風險刷流量端點）
  - name: rate-limiting
    route: api-posts-search
    config:
      minute: 60
      limit_by: ip
      policy: local
      fault_tolerant: true

  # 4️⃣ Post 其餘受保護 API
  - name: rate-limiting
    route: api-protected
    config:
      minute: 300
      limit_by: consumer
      policy: local
      fault_tolerant: true

  # ======================
  # CORS（原本設定，未修改）
  # ======================
  - name: cors
    config:
      origins:
        - https://ntouber.zeabur.app
        - http://localhost:8080
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - Authorization
      credentials: false
      max_age: 3600
